#!/bin/bash
# SPDX-License-Identifier: Apache-2.0
# Copyright Â© 2025 Rejeb Ben Rejeb

set -e

APP_DIR="/usr/lib/thermalright-lcd-control"
VENV_DIR="/opt/thermalright-lcd-control/venv"
CONFIG_DIR="/etc/thermalright-lcd-control"
THEMES_DIR="/usr/share/thermalright-lcd-control"
case "$1" in
    install|upgrade)
        echo "Preparing for thermalright-lcd-control installation/upgrade..."

        # Stop service if running
        if systemctl is-active --quiet thermalright-lcd-control.service 2>/dev/null; then
            echo "Stopping thermalright-lcd-control service..."
            systemctl stop thermalright-lcd-control.service
        fi

        # Clean up Python cache files that might cause issues
        if [ -d "$APP_DIR" ]; then
            echo "Cleaning Python cache files..."
            find "$APP_DIR" -name "*.pyc" -delete 2>/dev/null
            find "$APP_DIR" -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null
        fi

        # Remove virtual environment for clean reinstall
        if [ -d "$VENV_DIR" ]; then
            echo "Removing existing virtual environment for clean installation..."
            rm -rf "$VENV_DIR"
        fi

        # Remove config dir for clean reinstall
        if [ -d "$CONFIG_DIR" ]; then
            echo "Removing existing config dir for clean installation..."
            rm -rf "$CONFIG_DIR"
        fi

        # Remove themes dir for clean reinstall
        if [ -d "$THEMES_DIR" ]; then
            echo "Removing existing themes dir for clean installation..."
            rm -rf "$THEMES_DIR"
        fi

        echo "Pre-installation cleanup completed"
        ;;
esac

exit 0